trigger:
  branches:
    include:
      - master
  paths:
    exclude:
      - azure-pipelines.yml
      - README.md
      - docs/**

pool:
  name: MyFreePool
  demands:
    - agent -equals agent2

variables:
  - name: node_version
    value: '18.x'

stages:
# 1. Install Stage
- stage: Install
  displayName: "Install Dependencies"
  jobs:
    - job: InstallNode
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: '$(node_version)'
          displayName: 'Install Node.js'
        - task: CmdLine@2
          displayName: 'Install NPM dependencies'
          inputs:
            script: npm ci --no-audit --no-fund

# 2. Test Stage
- stage: Test
  displayName: "Run Unit Tests"
  dependsOn:
    - Install
  jobs:
    - job: RunTests
      steps:
        - task: Cache@2
          inputs:
            key: 'npm | "$(Agent.OS)" | $(Build.SourcesDirectory)/package-lock.json'
            restoreKeys: |
              npm | "$(Agent.OS)"
            path: $(Build.SourcesDirectory)/node_modules
          displayName: 'Cache node_modules'
          continueOnError: true
        - task: CmdLine@2
          displayName: 'Run tests'
          inputs:
            script: npm test

# 3. Package Stage
- stage: Package
  displayName: "Package App"
  dependsOn:
    - Test
  jobs:
    - job: ArchiveAndPublish
      steps:
        - task: CmdLine@2
          displayName: 'Build step (Optional)'
          inputs:
            script: echo "No build step needed for Express"
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(Build.SourcesDirectory)'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/shopingkaro.zip'
            replaceExistingArchive: true
          displayName: 'Archive app'
        - task: PublishBuildArtifacts@1
          inputs:
            pathToPublish: '$(Build.ArtifactStagingDirectory)/shopingkaro.zip'
            artifactName: 'shopingkaro-app'
            publishLocation: 'Container'
          displayName: 'Publish artifact'

# 4. Release Approval Stage
- stage: Release
  displayName: "Release Approval Stage"
  dependsOn:
    - Package
  condition: succeeded()
  jobs:
    - deployment: NotifyRelease
      displayName: "Release Confirmation"
      environment:
        name: Release
      strategy:
        runOnce:
          deploy:
            steps:
              - task: CmdLine@2
                displayName: 'Release Confirmation'
                inputs:
                  script: echo " Application ready for production deployment."

# 5. Deploy Stage
- stage: Deploy
  displayName: "Deploy to Azure"
  dependsOn:
    - Release
  jobs:
    - deployment: DeployToAzureAppService
      displayName: "Deploy Web App"
      environment:
        name: deployappr
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@0
                inputs:
                  artifactName: 'shopingkaro-app'
                  downloadPath: '$(Pipeline.Workspace)'
                displayName: 'Download build artifact'
              - task: AzureWebApp@1
                inputs:
                  azureSubscription: 'azure-rm-shopingkaro'
                  appType: 'webApp'
                  appName: 'shopingkaro-app-service'
                  package: '$(Pipeline.Workspace)/shopingkaro-app/shopingkaro.zip'
                displayName: 'Deploy to Azure Web App'
